%description:

Checks module interface lookup for IEEE 802.11 network interface module.

%file: TestNetwork.ned

import inet.common.MessageDispatcher;
import inet.mobility.static.StationaryMobility;
import inet.linklayer.ieee80211.Ieee80211Interface;
import inet.networklayer.common.InterfaceTable;
import inet.physicallayer.wireless.ieee80211.packetlevel.Ieee80211RadioMedium;

network TestNetwork
{
    parameters:
        *.interfaceTableModule = absPath(".interfaceTable");
        mobility.subjectModule = ".";
        mobility.initialX = 0m;
        mobility.initialY = 0m;
        mobility.initialZ = 0m;
        mobility.initFromDisplayString = false;
        ieee80211Interface.radio.antenna.mobilityModule = absPath(".mobility");
        @networkNode;
    submodules:
        mobility: StationaryMobility;
        radioMedium: Ieee80211RadioMedium;
        messageDispatcher: MessageDispatcher;
        interfaceTable: InterfaceTable;
        ieee80211Interface: Ieee80211Interface;
        test: Test;
    connections allowunconnected:
        ieee80211Interface.upperLayerOut --> messageDispatcher.in++;
        ieee80211Interface.upperLayerIn <-- messageDispatcher.out++;
}

%inifile: omnetpp.ini

[General]
network = TestNetwork
ned-path = .;../../../../src
sim-time-limit = 0s

cmdenv-log-prefix = "%>"

%includes
#include "inet/common/IModuleInterfaceLookup.h"
#include "inet/common/ProtocolTag_m.h"
#include "inet/common/packet/Packet.h"
#include "inet/linklayer/common/InterfaceTag_m.h"
#include "inet/queueing/contract/IPassivePacketSink.h"

%activity:
using namespace inet;
using namespace inet::queueing;

#define CHECK(gate, argument) { std::cerr << printToStringIfPossible(argument, 0) << " --> " << (findModuleInterface(gate, typeid(IPassivePacketSink), &argument) != nullptr ? "found" : "not found") << std::endl; }

auto messageDispatcher = cSimulation::getActiveSimulation()->getSystemModule()->getModuleByPath("messageDispatcher");
auto ieee80211Interface = messageDispatcher->gate("out", 0);

InterfaceReq interfaceReq;
interfaceReq.setInterfaceId(100);
CHECK(ieee80211Interface, interfaceReq);

DispatchProtocolReq dispatchProtocolReq;
dispatchProtocolReq.setServicePrimitive(SP_REQUEST);

dispatchProtocolReq.setProtocol(&Protocol::ieee8022llc);
CHECK(ieee80211Interface, dispatchProtocolReq);

dispatchProtocolReq.setProtocol(&Protocol::ethernetMac);
CHECK(ieee80211Interface, dispatchProtocolReq);

dispatchProtocolReq.setProtocol(&Protocol::ppp);
CHECK(ieee80211Interface, dispatchProtocolReq);

dispatchProtocolReq.setProtocol(&Protocol::ipv4);
CHECK(ieee80211Interface, dispatchProtocolReq);

%contains: stderr
InterfaceReq, interfaceId = 100 --> found
DispatchProtocolReq, protocol = ieee8022llc(33), servicePrimitive = 1 (SP_REQUEST) --> found
DispatchProtocolReq, protocol = ethernetmac(12), servicePrimitive = 1 (SP_REQUEST) --> not found
DispatchProtocolReq, protocol = ppp(52), servicePrimitive = 1 (SP_REQUEST) --> not found
DispatchProtocolReq, protocol = ipv4(38), servicePrimitive = 1 (SP_REQUEST) --> not found

%#--------------------------------------------------------------------------------------------------------------
%postrun-command: grep "undisposed object:" test.out > test_undisposed.out || true
%not-contains: test_undisposed.out
undisposed object: (
%#--------------------------------------------------------------------------------------------------------------
