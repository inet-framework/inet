[General]
seed-set = 1
sim-time-limit = 20s
description = "abstract"
abstract = true

# enable time synchronization in all network nodes
*.*.hasTimeSynchronization = true

*.tsnClock.clock.oscillator.initialDriftRate = 0ppm

**.clock.oscillator.typename = "RandomDriftOscillator"
**.oscillator.driftRate = uniform(-100ppm, 100ppm) # According to 802.1AS B.1.1
**.oscillator.initialDriftRate = uniform(-100ppm, 100ppm) # According to 802.1AS B.1.1
**.oscillator.changeInterval = 12.5ms

# Arbitrary large value
# According to the standard this value should be much smaller
**.oscillator.driftRateChange = uniform(-1ppm, 1ppm)
# => This setting leads to greater errors, espacially when using the nrr calculation (drift changes faster than nrr can adapt).
# A more realistic setting would be this:
# Based on 802.1AS B.1.3.2 (simplified to max error being 5ns/s, needs to be adapted if changeInterval is also adapted)
# **.oscillator.driftRateChange = uniform(-0.1235e-3 ppm, 0.1235e-3 ppm) 
# However, then the clock drift is not really visible anymore.
# See RateRatioStudies for more.


#**.oscillator.driftRateChange = uniform(-0.1235e-3 ppm, 0.1235e-3 ppm) # Based on 802.1AS B.1.3.2 (simplified to max error being 5ns/s, needs to be adapted if changeInterval is also adapted)
**.oscillator.driftRateChangeUpperLimit = 100ppm # According to 802.1AS B.1.1
**.oscillator.driftRateChangeLowerLimit = -100ppm # According to 802.1AS B.1.1

**.kp=8
**.ki=7
**.offsetThreshold = 0 us


# all Ethernet interfaces have 100 Mbps speed
*.*.eth[*].bitrate = 100Mbps

*.visualizer.typename = "IntegratedMultiCanvasVisualizer"
*.visualizer.infoVisualizer[*].displayInfos = true


[Config OneMasterClock]
network = OneMasterClockGptpShowcase
description = "Basic tree topology with one master clock"

# TSN clock gPTP master ports
*.tsnClock.gptp.masterPorts = ["eth0"]

# TSN switch gPTP bridge master ports
*.tsnSwitch.gptp.masterPorts = ["eth1", "eth2"]

*.tsnSwitch.clock.typename = "InstantServoClock"
*.tsnSwitch.clock.adjustDrift = false
*.tsnDevice2.clock.typename = "InstantServoClock"
*.tsnDevice2.clock.adjustDrift = true

# Set all reference clocks to master clock so the time difference can be visualized
**.referenceClock = "tsnClock.clock"

# data link visualizer displays gPTP time synchronization packets
*.visualizer.dataLinkVisualizer[0].displayLinks = true
*.visualizer.dataLinkVisualizer[0].activityLevel = "protocol"
*.visualizer.dataLinkVisualizer[0].packetFilter = "GptpSync"
*.visualizer.dataLinkVisualizer[0].lineColor = "blue2"

*.visualizer.numInfoVisualizers = 3
*.visualizer.infoVisualizer[0].modules = "*.tsnClock.clock"
*.tsnClock.clock.displayStringTextFormat = "time: %T"
*.visualizer.infoVisualizer[1].modules = "*.tsnSwitch.clock"
*.visualizer.infoVisualizer[1].placementHint = "topLeft"
*.visualizer.infoVisualizer[2].modules = "*.tsnDevice*.clock"
*.visualizer.infoVisualizer[2].placementHint = "bottom"
*.tsnDevice*.clock.displayStringTextFormat = "diff: %d"
*.tsnSwitch.clock.displayStringTextFormat = "diff: %d"


[Config MultiHop]
network = MultiHopGptpShowcase
description = "Basic tree topology with one master clock and multiple devices"
num-rngs = 2
seed-1-mt = 134

**.tsnClock.**.rng-0 = 1
**.clock.oscillator.typename = "RandomDriftOscillator"

*.numSwitches = ${numHops=1,10,50,100}

# TSN clock gPTP master ports
*.tsnClock.gptp.masterPorts = ["eth0"]

# TSN switch gPTP bridge master ports
*.tsnSwitch[*].gptp.masterPorts = ["eth1"]

# Set all reference clocks to master clock so the time difference can be visualized
**.referenceClock = "tsnClock.clock"

# data link visualizer displays gPTP time synchronization packets
*.visualizer.dataLinkVisualizer[0].displayLinks = true
*.visualizer.dataLinkVisualizer[0].activityLevel = "protocol"
*.visualizer.dataLinkVisualizer[0].packetFilter = "GptpSync"
*.visualizer.dataLinkVisualizer[0].lineColor = "blue2"

*.visualizer.numInfoVisualizers = 3
*.visualizer.infoVisualizer[0].modules = "*.tsnClock.clock"
*.tsnClock.clock.displayStringTextFormat = "time: %T"
*.visualizer.infoVisualizer[1].modules = "*.tsnSwitch*.clock"
*.visualizer.infoVisualizer[1].placementHint = "top"
*.visualizer.infoVisualizer[2].modules = "*.tsnDevice.clock"
*.visualizer.infoVisualizer[2].placementHint = "bottom"
*.tsnDevice.clock.displayStringTextFormat = "diff: %d"
*.tsnSwitch*.clock.displayStringTextFormat = "diff: %d"

[ParameterStudies]
extends=OneMasterClock
description="Study effect of kp and ki"
**.kp = ${kp=0,7.0,7.1,7.2,7.3,7.4,7.5,7.6,7.7,7.8,7.9,8}
**.ki = ${ki=0,2,3,4,5,6,7,8,9,10}

[Config RateRatioStudies]
network = MultiHopGptpShowcase
description = "Basic tree topology with one master clock and multiple devices"
num-rngs = 2
seed-1-mt = 134

**.tsnClock.**.rng-0 = 1
**.clock.oscillator.typename = "RandomDriftOscillator"

*.numSwitches = 50

# TSN clock gPTP master ports
*.tsnClock.gptp.masterPorts = ["eth0"]

# TSN switch gPTP bridge master ports
*.tsnSwitch[*].gptp.masterPorts = ["eth1"]

# Set all reference clocks to master clock so the time difference can be visualized
**.referenceClock = "tsnClock.clock"

# data link visualizer displays gPTP time synchronization packets
*.visualizer.dataLinkVisualizer[0].displayLinks = true
*.visualizer.dataLinkVisualizer[0].activityLevel = "protocol"
*.visualizer.dataLinkVisualizer[0].packetFilter = "GptpSync"
*.visualizer.dataLinkVisualizer[0].lineColor = "blue2"

*.visualizer.numInfoVisualizers = 3
*.visualizer.infoVisualizer[0].modules = "*.tsnClock.clock"
*.tsnClock.clock.displayStringTextFormat = "time: %T"
*.visualizer.infoVisualizer[1].modules = "*.tsnSwitch*.clock"
*.visualizer.infoVisualizer[1].placementHint = "top"
*.visualizer.infoVisualizer[2].modules = "*.tsnDevice.clock"
*.visualizer.infoVisualizer[2].placementHint = "bottom"
*.tsnDevice.clock.displayStringTextFormat = "diff: %d"
*.tsnSwitch*.clock.displayStringTextFormat = "diff: %d"

**.useNrr = ${nrr=false,true}
**.gmRateRatioCalculationMethod = ${gmMethod="NONE","NRR","DIRECT"}
**.oscillator.driftRateChange = uniform(${driftRateChange=0.1235e-3, 1} * -1ppm, ${driftRateChange} * 1ppm)


[JumpingClock]
extends = OneMasterClock
network = JumpingClockGptpShowcase
description="See how the clock behaves when the master clock jumps 1us"
*.tsnClock.gptp.masterPorts = ["eth0"]
*.tsnClock.clock.typename = "InstantServoClock"
*.tsnClock.clock.oscillator.typename = "IdealOscillator"
*.tsnDevice.clock.oscillator.typename = "ConstantDriftOscillator"

*.scenarioManager.script = xmldoc("scenario-jumping-clock.xml")
*.tsnDevice.clock.offsetThreshold = 2us

